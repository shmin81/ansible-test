---
# tasks file for install_openjdk
- name: Ensure configuration
  block:
  - fail:
      msg: You must set "openjdk_version" for this role to run
    when: openjdk_version is not defined

- name: check Java Version
  command: java --version
  register: java_version_infos
  ignore_errors: True

- name: print java version
  debug: 
    var: java_version_infos.stdout
  when: java_version_infos.rc == 0

# - name: check AdoptOpenJDK
#   command: javac --version
#   register: javac_version_infos
#   when: java_version_infos.rc == 0
#   ignore_errors: True

# - name: print javac version
#   debug: 
#     var: javac_version_infos
#   when: javac_version_infos is defined

- name: ensure installed java version for besu
  block:
    - fail:
        msg: Other type JDK Version (need {{ openjdk_name_comp }})
      when: java_version_infos.stdout.find(openjdk_name_comp) == -1
    - fail:
        msg: 'Wrong JDK Version (installed version: {{ java_version_infos.stdout }})'
      when: java_version_infos.stdout.find(openjdk_version_comp) == -1
  when: java_version_infos.rc == 0

- name: install {{ openjdk_name }}
  block:
  - name: install software-properties-common packages
    apt: name=software-properties-common update_cache=yes 

  - name: Add an Apt signing key, uses whichever key is at the URL
    apt_key: 
      url: "{{ openjdk_apt_key_url }}"

    # 왜 에러발생??
    # - name: Add APT repository for 'AdoptOpenJDK'
    #   apt_repository:
    #     repo: deb https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/ stable main
    #     state: present
    #     update_cache: true
  - name: Add APT repository for 'AdoptOpenJDK'
    shell: |
      add-apt-repository --yes {{ openjdk_apt_repo }}
    args:
      executable: /bin/bash

  - name: install jdk package
    apt: name={{ openjdk_name }} update_cache=yes 

  environment: "{{ env|d({}) }}"
  when: java_version_infos.rc != 0
  become: true

  